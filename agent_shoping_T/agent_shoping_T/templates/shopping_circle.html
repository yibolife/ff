{% extends "base.html" %}

{% block title %}购物圈 - 代购/购物系统{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header bg-success text-white">
            <h2 class="text-center mb-0">购物用户需求商品信息</h2>
        </div>
        <div class="card-body">
            {% if shopping_data %}
                <div class="row g-4">
                    {% for data in shopping_data %}
                        <div class="col-md-6">
                            <div class="border p-3 rounded shadow-sm h-100">
                                <!-- 非代购用户基本信息 -->
                                <h4>购物人：{{ data.user.username }}</h4>
                                <p>
                                    <strong>联系电话：</strong>
                                    {% if data.user.phone %}
                                        {{ data.user.phone[:3] }}****{{ data.user.phone[-4:] }}
                                    {% else %}
                                        未填写
                                    {% endif %}
                                </p>

                                <!-- 购物圈信息 -->
                                <p><strong>提交时间：</strong>{{ data.circle_info.submit_time.strftime('%Y-%m-%d %H:%M') }}</p>
                                <p><strong>总金额：</strong><span class="text-danger">{{ "%.2f"|format(data.circle_info.total_price) }} 元</span></p>

                                <!-- 商品列表（与 shopping-info 图片预览保持一致） -->
                                <div class="mt-3">
                                    <h5>商品列表：</h5>
                                    <div class="bg-light p-3 rounded">
                                        {% for product in data.products %}
                                            <div class="mb-4 pb-4 border-bottom">
                                                <div class="d-flex gap-3 align-items-center">
                                                    <!-- 商品缩略图（对齐 shopping-info：50x50px，带边框圆角） -->
                                                    <div class="flex-shrink-0">
                                                        {% if product.product_image %}
                                                            {% set image_path = url_for('static', filename='uploads/' + product.product_image) %}
                                                            <!-- 触发模态框的缩略图（与 shopping-info 尺寸、样式一致） -->
                                                            <button type="button" class="btn p-0" data-bs-toggle="modal" data-bs-target="#imageModal{{ product.id }}" title="查看大图">
                                                                <img
                                                                    src="{{ image_path }}"
                                                                    alt="{{ product.product_name }}"
                                                                    style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #eee;"
                                                                    onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default-product.png') }}'"
                                                                />
                                                            </button>

                                                            <!-- 大图预览模态框（完全对齐 shopping-info 样式） -->
                                                            <div class="modal fade" id="imageModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                                                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                                                    <div class="modal-content">
                                                                        <!-- 模态框头部（带商品名称+关闭按钮） -->
                                                                        <div class="modal-header">
                                                                            <h5 class="modal-title">{{ product.product_name }}</h5>
                                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                        </div>
                                                                        <!-- 模态框主体（图片自适应显示） -->
                                                                        <div class="modal-body p-0">
                                                                            <img
                                                                                src="{{ image_path if product.product_image else url_for('static', filename='images/default-product.png') }}"
                                                                                alt="{{ product.product_name }}"
                                                                                style="width: 100%; height: auto; object-fit: contain;"
                                                                            />
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% else %}
                                                            <!-- 无图片：与 shopping-info 一致的文本提示 -->
                                                            <span class="text-muted" style="width: 50px; display: inline-block;">无图片</span>
                                                        {% endif %}
                                                    </div>

                                                    <!-- 商品基本信息（保持原有逻辑，优化对齐） -->
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold">{{ product.serial_number }}. {{ product.product_name }}</span>
                                                            <span class="text-danger">{{ "%.2f"|format(product.price) }} 元</span>
                                                        </div>
                                                        {% if product.description %}
                                                            <small class="text-muted mt-1 d-block">{{ product.description }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- 联系按钮：修改为直接确认绑定 -->
                                <div class="mt-4">
                                    {% if current_user.is_authenticated and current_user.is_agent %}
                                        {% if has_valid_itinerary %}
                                            <!-- 核心修改：跳转路由改为直接确认绑定，按钮文本调整 -->
                                            <a href="{{ url_for('binding.bind_buyer_direct_confirm', buyer_id=data.user.id) }}" class="btn btn-success" onclick="return confirm('确定要直接绑定该买家吗？绑定后状态为已确认！')">
                                                <i class="bi bi-handshake"></i> 联系并确认绑定
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('agent.agent_info', redirect_source='shopping_circle', target_buyer_id=data.user.id) }}" class="btn btn-success">
                                                <i class="bi bi-handshake"></i> 联系该用户（需完善行程）
                                            </a>
                                            <div class="form-text text-warning mt-1">
                                                提示：需先填写行程并点击「加入代购圈」，才能联系买家
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center p-5">
                    <p class="fs-5 text-muted">当前暂无未绑定的非代购用户商品信息（所有非代购用户已被绑定或未提交购物信息）</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 引入Bootstrap图标（与 shopping-info 一致） -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}