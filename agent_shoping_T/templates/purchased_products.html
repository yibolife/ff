{% extends "base.html" %}

{% block title %}我的代购行程 - 代购购物平台{% endblock %}

{% block content %}
<!-- 苹果风格核心样式 -->
<style>
    /* 引入苹果官方字体 */
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap');

    :root {
        /* 苹果原生色调体系 */
        --apple-bg: #f5f5f7;
        --apple-card-bg: #ffffff;
        --apple-border: #e6e6e8;
        --apple-text-primary: #1d1d1f;
        --apple-text-secondary: #86868b;
        --apple-accent: #0071e3; /* 苹果蓝 */
        --apple-success: #34c759; /* 苹果绿 */
        --apple-warning: #ff9500; /* 苹果橙 */
        --apple-danger: #ff3b30; /* 苹果红 */
        --apple-secondary: #86868b; /* 苹果灰 */
        --apple-light-blue: rgba(0, 113, 227, 0.1); /* 浅蓝背景 */

        /* 苹果风格阴影 */
        --apple-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
        --apple-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* 全局样式重置 */
    * {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
    }

    body {
        background-color: var(--apple-bg) !important;
        color: var(--apple-text-primary) !important;
        -webkit-font-smoothing: antialiased;
        padding-bottom: 2rem;
    }

    /* 新增：返回购物信息按钮样式 */
    .apple-back-shopping-btn {
        background-color: var(--apple-light-blue) !important;
        color: var(--apple-accent) !important;
        border: none !important;
        border-radius: 16px !important;
        padding: 0.5rem 1rem !important;
        font-size: 0.9rem !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        margin-bottom: 1rem !important;
        transition: background-color 0.2s ease-in-out !important;
    }

    .apple-back-shopping-btn:hover {
        background-color: rgba(0, 113, 227, 0.2) !important;
        text-decoration: none !important;
    }

    /* 页面标题 */
    .apple-page-title {
        font-weight: 600 !important;
        font-size: 1.75rem !important;
        color: var(--apple-text-primary) !important;
        margin-bottom: 1.5rem !important;
        letter-spacing: -0.02em !important;
    }

    /* 苹果风格行程卡片 */
    .apple-trip-card {
        background-color: var(--apple-card-bg) !important;
        border-radius: 16px !important;
        border: 1px solid var(--apple-border) !important;
        box-shadow: var(--apple-shadow-sm) !important;
        padding: 1.5rem !important;
        margin-bottom: 1rem !important;
        transition: box-shadow 0.2s ease-in-out !important;
    }

    .apple-trip-card:hover {
        box-shadow: var(--apple-shadow) !important;
    }

    /* 卡片头部信息 */
    .apple-card-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: flex-start !important;
        flex-wrap: wrap !important;
        margin-bottom: 1rem !important;
    }

    .apple-card-title {
        font-weight: 500 !important;
        font-size: 1.1rem !important;
        color: var(--apple-text-primary) !important;
        margin: 0 !important;
    }

    .apple-card-time {
        font-size: 0.85rem !important;
        color: var(--apple-text-secondary) !important;
        margin-top: 0.25rem !important;
    }

    /* 状态标签 */
    .apple-badge {
        border-radius: 12px !important;
        padding: 0.25rem 0.75rem !important;
        font-size: 0.8rem !important;
        font-weight: 500 !important;
        border: none !important;
    }

    .apple-badge-success {
        background-color: var(--apple-success) !important;
        color: white !important;
    }

    .apple-badge-warning {
        background-color: var(--apple-warning) !important;
        color: white !important;
    }

    .apple-badge-secondary {
        background-color: var(--apple-secondary) !important;
        color: white !important;
    }

    /* 联系方式区域 */
    .apple-contact-row {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        flex-wrap: wrap !important;
        margin-bottom: 1rem !important;
        padding-bottom: 0.75rem !important;
        border-bottom: 1px solid var(--apple-border) !important;
    }

    .apple-contact-text {
        font-size: 0.95rem !important;
        margin: 0 !important;
    }

    /* 购物信息区域 */
    .apple-shopping-info {
        margin-bottom: 1rem !important;
    }

    .apple-shopping-text {
        font-size: 0.95rem !important;
        margin-bottom: 0.25rem !important;
    }

    .apple-price-text {
        color: var(--apple-danger) !important;
        font-weight: 600 !important;
    }

    /* 商品清单 */
    .apple-product-list {
        background-color: var(--apple-bg) !important;
        border-radius: 12px !important;
        padding: 1rem !important;
        margin-bottom: 1rem !important;
    }

    .apple-product-list-title {
        font-weight: 500 !important;
        font-size: 0.95rem !important;
        margin-bottom: 0.75rem !important;
        color: var(--apple-text-primary) !important;
    }

    .apple-product-item {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 0.75rem 0 !important;
        border-bottom: 1px solid var(--apple-border) !important;
    }

    .apple-product-item:last-child {
        border-bottom: none !important;
    }

    .apple-product-name {
        font-size: 0.9rem !important;
    }

    .apple-product-desc {
        font-size: 0.8rem !important;
        color: var(--apple-text-secondary) !important;
        margin-top: 0.25rem !important;
        display: block !important;
    }

    .apple-product-price {
        font-size: 0.9rem !important;
        font-weight: 500 !important;
    }

    /* 行程信息区域 */
    .apple-itinerary-card {
        background-color: var(--apple-light-blue) !important;
        border-radius: 12px !important;
        padding: 1rem !important;
        margin-bottom: 1rem !important;
    }

    .apple-itinerary-title {
        font-weight: 500 !important;
        font-size: 1rem !important;
        color: var(--apple-accent) !important;
        margin-bottom: 0.75rem !important;
    }

    .apple-itinerary-text {
        font-size: 0.9rem !important;
        margin-bottom: 0.5rem !important;
    }

    .apple-itinerary-row {
        display: flex !important;
        justify-content: space-between !important;
        flex-wrap: wrap !important;
        gap: 1rem !important;
    }

    /* 按钮样式 */
    .btn-apple {
        border-radius: 20px !important;
        font-weight: 500 !important;
        padding: 0.5rem 1rem !important;
        font-size: 0.85rem !important;
        border: none !important;
        transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .btn-apple-primary {
        background-color: var(--apple-accent) !important;
        color: white !important;
    }

    .btn-apple-primary:hover {
        background-color: #0077ed !important;
        box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3) !important;
    }

    .btn-apple-success {
        background-color: var(--apple-success) !important;
        color: white !important;
    }

    .btn-apple-success:hover {
        background-color: #2db84e !important;
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3) !important;
    }

    .btn-apple-danger {
        background-color: var(--apple-danger) !important;
        color: white !important;
    }

    .btn-apple-danger:hover {
        background-color: #ff2d37 !important;
        box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3) !important;
    }

    .btn-apple-outline-secondary {
        border: 1px solid var(--apple-border) !important;
        color: var(--apple-text-secondary) !important;
        background-color: transparent !important;
        border-radius: 20px !important;
        padding: 0.5rem 1rem !important;
        font-size: 0.85rem !important;
        font-weight: 500 !important;
    }

    .btn-apple-outline-secondary:disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }

    /* 按钮组 */
    .apple-btn-group {
        display: flex !important;
        gap: 0.75rem !important;
        flex-wrap: wrap !important;
        margin-top: 1rem !important;
    }

    /* 空状态提示 */
    .apple-empty-state {
        background-color: var(--apple-card-bg) !important;
        border-radius: 16px !important;
        border: 1px solid var(--apple-border) !important;
        padding: 2rem !important;
        text-align: center !important;
        margin-top: 2rem !important;
    }

    .apple-empty-icon {
        font-size: 2rem !important;
        color: var(--apple-accent) !important;
        margin-bottom: 1rem !important;
    }

    .apple-empty-text {
        font-size: 1rem !important;
        color: var(--apple-text-primary) !important;
        margin-bottom: 0.5rem !important;
    }

    .apple-empty-subtext {
        font-size: 0.9rem !important;
        color: var(--apple-text-secondary) !important;
        margin-bottom: 1.5rem !important;
    }

    /* 响应式适配 */
    @media (max-width: 768px) {
        .apple-trip-card {
            padding: 1.25rem !important;
        }

        .apple-page-title {
            font-size: 1.5rem !important;
        }

        .apple-card-header {
            flex-direction: column !important;
        }

        .apple-card-time {
            margin-top: 0.5rem !important;
        }

        .apple-btn-group {
            gap: 0.5rem !important;
        }

        .btn-apple {
            flex: 1 !important;
            text-align: center !important;
        }
    }

    @media (max-width: 576px) {
        .apple-trip-card {
            padding: 1rem !important;
        }

        .apple-empty-state {
            padding: 1.5rem 1rem !important;
        }

        .apple-itinerary-row {
            flex-direction: column !important;
            gap: 0.5rem !important;
        }
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- 修正：使用带蓝图前缀的路由名称 shopping.shopping_info -->
            <a href="{{ url_for('shopping.shopping_info') }}" class="apple-back-shopping-btn">
                <i class="bi bi-cart3"></i> 购物信息
            </a>

            <!-- 页面标题 -->
            <h2 class="apple-page-title">
                {% if current_user.is_agent %}
                    我的代购行程
                {% endif %}
            </h2>

            {% if trips %}
                {% for item in trips %}
                    {% set binding = item.binding %}
                    {% set agent_itinerary = item.agent_itinerary %}
                    {% set agent_user = item.agent_user or {} %}
                    {% set buyer = item.buyer or {} %}
                    {% set buyer_circle = item.buyer_circle %}
                    {% set buyer_products = item.buyer_products or [] %}

                    <!-- 苹果风格行程卡片 -->
                    <div class="apple-trip-card">
                        <!-- 1. 对方信息 -->
                        <div class="apple-card-header">
                            <h5 class="apple-card-title">
                                {% if current_user.is_agent %}
                                    联系人（买家）：{{ buyer.username|default('未知用户', true) }}
                                {% else %}
                                    代购：{{ agent_user.username|default('未知代购', true) }}
                                {% endif %}
                            </h5>
                            <small class="apple-card-time">
                                绑定时间：{{ binding.created_at.strftime('%Y-%m-%d %H:%M') if binding and binding.created_at else '未知时间' }}
                            </small>
                        </div>

                        <!-- 2. 联系方式与绑定状态 -->
                        <div class="apple-contact-row">
                            <p class="apple-contact-text">
                                电话：
                                {% if current_user.is_agent and buyer.phone %}
                                    {{ buyer.phone[:3] }}****{{ buyer.phone[-4:] }}
                                {% elif not current_user.is_agent and agent_user.phone %}
                                    {{ agent_user.phone[:3] }}****{{ agent_user.phone[-4:] }}
                                {% else %}
                                    <span class="text-muted">未填写</span>
                                {% endif %}
                            </p>
                            <span class="apple-badge {% if binding.status in ['confirmed', 'binded'] %}apple-badge-success{% elif binding.status == 'pending' %}apple-badge-warning{% else %}apple-badge-secondary{% endif %}">
                                {{ binding.status|default('未知状态')|replace('confirmed', '已确认')|replace('pending', '待确认')|replace('binded', '已绑定') }}
                            </span>
                        </div>

                        <!-- 3. 购物信息 -->
                        {% if buyer_circle %}
                            <div class="apple-shopping-info">
                                <p class="apple-shopping-text">
                                    <strong>提交时间：</strong>{{ buyer_circle.submit_time.strftime('%Y-%m-%d %H:%M') if buyer_circle.submit_time else '未知' }}
                                </p>
                                <p class="apple-shopping-text">
                                    <strong>总金额：</strong><span class="apple-price-text">{{ "%.2f"|format(buyer_circle.total_price or 0) }} 元</span>
                                </p>
                            </div>
                        {% else %}
                            <p class="text-muted mb-2">暂无购物信息</p>
                        {% endif %}

                        <!-- 4. 商品列表 -->
                        {% if buyer_products %}
                            <div class="apple-product-list">
                                <h6 class="apple-product-list-title">商品清单（{{ buyer_products|length }} 件）：</h6>
                                {% for product in buyer_products %}
                                    <div class="apple-product-item">
                                        <div>
                                            <span>{{ loop.index }}. {{ product.product_name|default('未知商品', true) }}</span>
                                            {% if product.description %}
                                                <small class="apple-product-desc">{{ product.description }}</small>
                                            {% endif %}
                                        </div>
                                        <span>{{ product.price|default(0) }} 元</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif buyer_circle %}
                            <p class="text-muted">暂无商品信息</p>
                        {% endif %}

                        <!-- 5. 代购行程信息 -->
                        <div class="apple-itinerary-card">
                            <h5 class="apple-itinerary-title">代购行程</h5>
                            {% if agent_itinerary and agent_itinerary.itinerary %}
                                <p class="apple-itinerary-text"><strong>行程描述：</strong>{{ agent_itinerary.itinerary }}</p>
                                <div class="apple-itinerary-row">
                                    <p class="apple-itinerary-text"><strong>出行时间：</strong>{{ agent_itinerary.time.strftime('%Y-%m-%d %H:%M') if agent_itinerary.time else '未设置' }}</p>
                                    <p class="apple-itinerary-text"><strong>目的地：</strong>{{ agent_itinerary.location or '未设置' }}</p>
                                </div>
                            {% else %}
                                <p class="text-warning">代购尚未完善行程信息</p>
                            {% endif %}
                        </div>

                        <!-- 6. 操作按钮 -->
                        <div class="apple-btn-group">
                            <!-- 聊天入口 -->
                            {% if binding and binding.id and binding.status in ['confirmed', 'binded'] %}
                                <a href="{{ url_for('chat.chat_room', binding_id=binding.id) }}" class="btn btn-apple btn-apple-primary">
                                    <i class="bi bi-chat-dots"></i> 实时聊天
                                </a>
                            {% endif %}

                            <!-- 确认绑定按钮 -->
                            {% if current_user.is_agent and binding and binding.status == 'pending' and binding.id %}
                                <a href="{{ url_for('binding.confirm_binding', binding_id=binding.id) }}" class="btn btn-apple btn-apple-success">
                                    确认绑定
                                </a>
                            {% endif %}

                            <!-- 解除绑定按钮 -->
                            {% if binding and binding.id %}
                                <form action="{{ url_for('binding.unbind', binding_id=binding.id) }}" method="POST" style="display: inline;">
                                    {{ form.hidden_tag() }}
                                    {% if binding.status in ['confirmed', 'binded'] %}
                                        <button type="submit" class="btn btn-apple btn-apple-danger" onclick="return confirm('确定要解除与 {{ buyer.username|default(agent_user.username, true)|default('未知用户', true) }} 的绑定吗？解除后不可恢复！')">
                                            解除绑定
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-apple-outline-secondary" disabled>
                                            不可解除
                                        </button>
                                    {% endif %}
                                </form>
                            {% else %}
                                <button type="button" class="btn btn-apple-outline-secondary" disabled>
                                    无效绑定
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <!-- 无数据提示 -->
                <div class="apple-empty-state">
                    <i class="bi bi-info-circle apple-empty-icon"></i>
                    <p class="apple-empty-text">
                        {% if current_user.is_agent %}
                            暂无已绑定的代购行程
                        {% endif %}
                    </p>
                    <p class="apple-empty-subtext">
                        {% if current_user.is_agent %}
                            前往购物圈绑定买家，开始你的代购之旅
                        {% else %}
                            等到合适的代购绑定后即可查看订单
                        {% endif %}
                    </p>
                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <a href="{{ url_for('agent.agent_circle') }}" class="btn btn-apple btn-apple-primary">
                            {% if current_user.is_agent %}
                                前往购物圈绑定买家
                            {% else %}
                                前往代购圈
                            {% endif %}
                        </a>
                        {% if current_user.is_agent %}
                            <a href="{{ url_for('agent.agent_circle') }}" class="btn btn-apple btn-apple-outline-secondary">
                                完善代购行程
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 引入Bootstrap图标 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}