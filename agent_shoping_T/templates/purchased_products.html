{% extends "base.html" %}

{% block title %}我的代购行程 - 代购购物平台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 根据用户身份显示不同标题 -->
        <h2 class="mb-4">
            {% if current_user.is_agent %}
                我的代购行程
            {% else %}
                我的代购订单
            {% endif %}
        </h2>

        {% if trips %}
            {% for item in trips %}
                {% set binding = item.binding %}
                {% set agent_itinerary = item.agent_itinerary %}
                {% set agent_user = item.agent_user or {} %}  <!-- 代购信息（供非代购查看） -->
                {% set buyer = item.buyer or {} %}
                {% set buyer_circle = item.buyer_circle %}
                {% set buyer_products = item.buyer_products or [] %}

                <div class="list-group-item list-group-item-action mb-3 shadow-sm">
                    <!-- 1. 对方信息（代购看买家，买家看代购） -->
                    <div class="d-flex w-100 justify-content-between flex-wrap">
                        <h5 class="mb-1">
                            {% if current_user.is_agent %}
                                联系人（买家）：{{ buyer.username|default('未知用户', true) }}
                            {% else %}
                                代购：{{ agent_user.username|default('未知代购', true) }}
                            {% endif %}
                        </h5>
                        <small>绑定时间：{{ binding.created_at.strftime('%Y-%m-%d %H:%M') if binding and binding.created_at else '未知时间' }}</small>
                    </div>

                    <!-- 2. 联系方式与绑定状态 -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <p class="mb-0">
                            电话：
                            {% if current_user.is_agent and buyer.phone %}
                                {{ buyer.phone[:3] }}****{{ buyer.phone[-4:] }}
                            {% elif not current_user.is_agent and agent_user.phone %}
                                {{ agent_user.phone[:3] }}****{{ agent_user.phone[-4:] }}
                            {% else %}
                                <span class="text-muted">未填写</span>
                            {% endif %}
                        </p>
                        <span class="badge {% if binding.status in ['confirmed', 'binded'] %}bg-success{% elif binding.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ binding.status|default('未知状态')|replace('confirmed', '已确认')|replace('pending', '待确认')|replace('binded', '已绑定') }}
                        </span>
                    </div>

                    <!-- 3. 购物信息（提交时间+总金额） -->
                    {% if buyer_circle %}
                        <div class="mt-2">
                            <p class="mb-1">
                                <strong>提交时间：</strong>{{ buyer_circle.submit_time.strftime('%Y-%m-%d %H:%M') if buyer_circle.submit_time else '未知' }}
                            </p>
                            <p class="mb-1">
                                <strong>总金额：</strong><span class="text-danger">{{ "%.2f"|format(buyer_circle.total_price or 0) }} 元</span>
                            </p>
                        </div>
                    {% else %}
                        <p class="text-muted mb-2">暂无购物信息</p>
                    {% endif %}

                    <!-- 4. 商品列表 -->
                    {% if buyer_products %}
                        <div class="mt-2 bg-light p-3 rounded">
                            <h6>商品清单（{{ buyer_products|length }} 件）：</h6>
                            {% for product in buyer_products %}
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <div>
                                        <span>{{ loop.index }}. {{ product.product_name|default('未知商品', true) }}</span>
                                        {% if product.description %}
                                            <small class="d-block text-muted">{{ product.description }}</small>
                                        {% endif %}
                                    </div>
                                    <span>{{ product.price|default(0) }} 元</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% elif buyer_circle %}
                        <p class="text-muted">暂无商品信息</p>
                    {% endif %}

                    <!-- 5. 代购行程信息（所有用户都能查看） -->
                    <div class="bg-primary/10 p-3 rounded mt-3">
                        <h5 class="text-primary">代购行程</h5>
                        {% if agent_itinerary and agent_itinerary.itinerary %}
                            <p><strong>行程描述：</strong>{{ agent_itinerary.itinerary }}</p>
                            <div class="d-flex justify-content-between flex-wrap">
                                <p><strong>出行时间：</strong>{{ agent_itinerary.time.strftime('%Y-%m-%d %H:%M') if agent_itinerary.time else '未设置' }}</p>
                                <p><strong>目的地：</strong>{{ agent_itinerary.location or '未设置' }}</p>
                            </div>
                        {% else %}
                            <p class="text-warning">代购尚未完善行程信息</p>
                        {% endif %}
                    </div>

                    <!-- 6. 操作按钮（根据用户身份和状态显示） -->
                    <div class="mt-4">
                        <!-- 代购用户：确认绑定按钮 -->
                        {% if current_user.is_agent and binding and binding.status == 'pending' and binding.id %}
                            <form action="{{ url_for('binding.confirm_binding', binding_id=binding.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('确定要确认绑定吗？')">
                                    确认绑定
                                </button>
                            </form>
                        {% endif %}

                        <!-- 替换原有的联系按钮代码 -->
                        {% if current_user.is_agent and buyer and buyer.id %}
                            <a href="{{ url_for('chat', user_id=buyer.id) }}" class="btn btn-sm btn-info ms-2">
                            联系买家
                            </a>
                        {% elif not current_user.is_agent and agent_user and agent_user.id %}
                            <a href="{{ url_for('chat', user_id=agent_user.id) }}" class="btn btn-sm btn-info ms-2">
                            联系代购
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <!-- 无数据提示（根据用户身份显示不同引导） -->
            <div class="alert alert-info text-center p-4">
                <i class="bi bi-info-circle fs-4"></i>
                <p class="mt-2">
                    {% if current_user.is_agent %}
                        暂无已绑定的代购行程
                    {% else %}
                        暂无已绑定的代购订单
                    {% endif %}
                </p>
                <div class="mt-3">
                    <a href="{{ url_for('agent.agent_circle') }}" class="btn btn-primary">
                        {% if current_user.is_agent %}
                            前往购物圈绑定买家
                        {% else %}
                            前往代购圈寻找代购
                        {% endif %}
                    </a>
                    {% if current_user.is_agent %}
                        <a href="{{ url_for('agent.agent_circle') }}" class="btn btn-secondary ms-2">完善代购行程</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}