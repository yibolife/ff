{% extends "base.html" %}

{% block title %}购物圈 - 代购/购物系统{% endblock %}

{% block content %}
<!-- 苹果风格核心样式（优化版） -->
<style>
    /* 引入苹果官方字体 */
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap');

    :root {
        /* 苹果原生色调体系（统一代购/购物圈风格） */
        --apple-bg: #f5f5f7;
        --apple-card-bg: #ffffff;
        --apple-border: #e6e6e8;
        --apple-text-primary: #1d1d1f;
        --apple-text-secondary: #86868b;
        --apple-accent: #0071e3; /* 苹果蓝 */
        --apple-success: #34c759; /* 苹果绿 */
        --apple-warning: #ff9500; /* 苹果橙 */
        --apple-danger: #ff3b30; /* 苹果红 */
        --apple-light-bg: #f2f2f7;

        /* 通用过渡动画（贴合iOS动效） */
        --apple-transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 全局样式重置 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--apple-bg);
        color: var(--apple-text-primary);
        line-height: 1.45;
        -webkit-font-smoothing: antialiased; /* 苹果字体抗锯齿 */
    }

    /* 页面容器优化（统一间距） */
    .apple-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    /* 主卡片样式（苹果风格核心） */
    .apple-main-card {
        background-color: var(--apple-card-bg);
        border-radius: 18px;
        border: 1px solid var(--apple-border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: var(--apple-transition);
    }

    /* 卡片头部样式（苹果绿+统一层级） */
    .apple-card-header {
        background-color: var(--apple-success);
        color: white;
        padding: 1.2rem 1.5rem;
        text-align: center;
        border-bottom: none;
    }

    .apple-card-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        letter-spacing: -0.02em; /* 苹果标题字距 */
        line-height: 1.2;
    }

    /* 卡片内容区（更细腻的内边距） */
    .apple-card-body {
        padding: 1.5rem;
    }

    /* 购物信息卡片（统一代购圈卡片风格） */
    .apple-shopping-card {
        background-color: var(--apple-card-bg);
        border: 1px solid var(--apple-border) !important;
        border-radius: 16px !important;
        padding: 1.5rem;
        transition: var(--apple-transition);
        height: 100%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .apple-shopping-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    /* 信息分组样式（统一标签+内容布局） */
    .info-group {
        display: flex;
        align-items: center;
        margin-bottom: 0.8rem;
    }
    .info-label {
        font-weight: 500;
        color: var(--apple-text-primary);
        min-width: 70px; /* 固定标签宽度，对齐更整齐 */
    }
    .info-content {
        color: var(--apple-text-secondary);
        flex: 1;
    }

    /* 商品列表区块（iOS小组件风格） */
    .apple-product-block {
        background-color: var(--apple-light-bg);
        border-radius: 12px;
        padding: 1rem;
        margin: 0.75rem 0;
        border: none;
        transition: var(--apple-transition);
    }
    .apple-product-block:hover {
        background-color: #ebebef;
    }

    /* 商品项样式（优化分隔） */
    .apple-product-item {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--apple-border);
    }
    .apple-product-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    /* 商品图片样式（更精致） */
    .apple-product-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px !important; /* 苹果风格圆角 */
        border: 1px solid var(--apple-border) !important;
        transition: var(--apple-transition);
    }
    .apple-product-img:hover {
        transform: scale(1.05);
    }

    /* 苹果风格按钮（统一样式） */
    .btn-apple {
        border-radius: 20px;
        font-weight: 500;
        padding: 8px 16px;
        border: none;
        transition: var(--apple-transition);
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
    }
    .btn-apple-success {
        background-color: var(--apple-success);
        color: white;
    }
    .btn-apple-success:hover {
        background-color: #2db84e;
        color: white;
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        transform: translateY(-1px);
    }
    .btn-apple-success:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px rgba(52, 199, 89, 0.2);
    }

    /* 提示文本样式（优化层级） */
    .apple-tip-text {
        color: var(--apple-warning);
        font-size: 0.85rem;
        margin-top: 0.8rem;
        line-height: 1.4;
    }

    /* 空状态样式（统一iOS空页面风格） */
    .apple-empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--apple-text-secondary);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .apple-empty-state p {
        margin: 0.5rem 0;
        font-size: 1.1rem;
        line-height: 1.4;
    }
    .apple-empty-state p:first-child {
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--apple-text-primary);
        margin-bottom: 0.75rem;
    }

    /* 模态框样式优化（苹果风格） */
    .modal-content {
        border-radius: 18px !important;
        border: 1px solid var(--apple-border) !important;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    }
    .modal-header {
        border-bottom: 1px solid var(--apple-border) !important;
        padding: 1rem 1.5rem !important;
    }
    .modal-title {
        font-weight: 500 !important;
        color: var(--apple-text-primary) !important;
        font-size: 1rem !important;
    }
    .modal-body {
        padding: 0 !important;
    }
    .btn-close {
        opacity: 0.8 !important;
    }

    /* 文字样式优化（统一层级） */
    .text-primary-apple {
        color: var(--apple-text-primary);
    }
    .text-secondary-apple {
        color: var(--apple-text-secondary);
    }
    .text-danger-apple {
        color: var(--apple-danger); /* 苹果红色 */
    }

    /* 响应式适配（更细腻） */
    @media (max-width: 768px) {
        .apple-card-body {
            padding: 1rem;
        }
        .apple-shopping-card {
            padding: 1rem;
        }
        .btn-apple {
            width: 100%;
            padding: 10px 16px;
        }
        .apple-card-header h2 {
            font-size: 1.3rem;
        }
        .info-label {
            min-width: 60px; /* 移动端缩小标签宽度 */
        }
    }

    @media (max-width: 480px) {
        .apple-container {
            margin: 1rem auto;
        }
        .apple-card-header {
            padding: 1rem 1rem;
        }
        .apple-product-block {
            padding: 0.75rem;
        }
    }
</style>

<div class="apple-container">
    <!-- 主卡片容器 -->
    <div class="apple-main-card">
        <!-- 卡片头部 -->
        <div class="apple-card-header">
            <h2 class="mb-0">购物推荐</h2>
        </div>

        <!-- 卡片内容 -->
        <div class="apple-card-body">
            {% if shopping_data %}
                <div class="row g-4">
                    {% for data in shopping_data %}
                        <div class="col-md-6">
                            <div class="apple-shopping-card">
                                <!-- 买家基本信息（优化分组布局） -->
                                <h4 class="text-primary-apple mb-4" style="font-weight: 600; font-size: 1.2rem; letter-spacing: -0.01em;">
                                    买家：{{ data.user.username }}
                                </h4>

                                <!-- 电话信息 -->
                                <div class="info-group">
                                    <span class="info-label">电话：</span>
                                    <span class="info-content">
                                        {% if data.user.phone %}
                                            {{ data.user.phone[:3] }}****{{ data.user.phone[-4:] }}
                                        {% else %}
                                            未填写
                                        {% endif %}
                                    </span>
                                </div>

                                <!-- 提交时间 -->
                                <div class="info-group">
                                    <span class="info-label">提交时间：</span>
                                    <span class="info-content">
                                        {{ data.circle_info.submit_time.strftime('%Y-%m-%d %H:%M') }}
                                    </span>
                                </div>

                                <!-- 总金额（突出红色） -->
                                <div class="info-group mb-3">
                                    <span class="info-label">总金额：</span>
                                    <span class="text-danger-apple">
                                        {{ "%.2f"|format(data.circle_info.total_price) }} 元
                                    </span>
                                </div>

                                <!-- 商品列表（优化标题层级） -->
                                <div class="mt-1">
                                    <div class="info-label mb-2">商品列表：</div>
                                    <div class="apple-product-block">
                                        {% for product in data.products %}
                                            <div class="apple-product-item">
                                                <div class="d-flex gap-3 align-items-center">
                                                    <!-- 商品缩略图 -->
                                                    <div class="flex-shrink-0">
                                                        {% if product.product_image %}
                                                            {% set image_path = url_for('static', filename='uploads/' + product.product_image) %}
                                                            <!-- 触发模态框的缩略图 -->
                                                            <button type="button" class="btn p-0" data-bs-toggle="modal" data-bs-target="#imageModal{{ product.id }}" title="查看大图">
                                                                <img
                                                                    src="{{ image_path }}"
                                                                    alt="{{ product.product_name }}"
                                                                    class="apple-product-img"
                                                                    onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default-product.png') }}'"
                                                                />
                                                            </button>

                                                            <!-- 大图预览模态框（苹果风格） -->
                                                            <div class="modal fade" id="imageModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                                                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                                                    <div class="modal-content">
                                                                        <!-- 模态框头部 -->
                                                                        <div class="modal-header">
                                                                            <h5 class="modal-title">{{ product.product_name }}</h5>
                                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                        </div>
                                                                        <!-- 模态框主体 -->
                                                                        <div class="modal-body p-0">
                                                                            <img
                                                                                src="{{ image_path if product.product_image else url_for('static', filename='images/default-product.png') }}"
                                                                                alt="{{ product.product_name }}"
                                                                                style="width: 100%; height: auto; object-fit: contain;"
                                                                            />
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% else %}
                                                            <!-- 无图片提示（统一样式） -->
                                                            <span class="text-secondary-apple d-inline-block w-12 text-center" style="width: 50px; height: 50px; line-height: 50px; border: 1px solid var(--apple-border); border-radius: 8px;">无图片</span>
                                                        {% endif %}
                                                    </div>

                                                    <!-- 商品基本信息（优化布局） -->
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="fw-bold text-primary-apple">{{ product.serial_number }}. {{ product.product_name }}</span>
                                                            <span class="text-danger-apple">{{ "%.2f"|format(product.price) }} 元</span>
                                                        </div>
                                                        {% if product.description %}
                                                            <small class="text-secondary-apple d-block">{{ product.description }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- 联系按钮（统一苹果按钮风格） -->
                                <div class="mt-4">
                                    {% if current_user.is_authenticated and current_user.is_agent %}
                                        {% if has_valid_itinerary %}
                                            <!-- 直接确认绑定按钮 -->
                                            <a href="{{ url_for('binding.bind_buyer_direct_confirm', buyer_id=data.user.id) }}" class="btn btn-apple btn-apple-success" onclick="return confirm('确定要直接绑定该买家吗？绑定后状态为已确认！')">
                                                <i class="bi bi-handshake"></i> 绑定
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('agent.agent_info', redirect_source='shopping_circle', target_buyer_id=data.user.id) }}" class="btn btn-apple btn-apple-success">
                                                <i class="bi bi-handshake"></i> 联系该用户（需完善行程）
                                            </a>
                                            <div class="apple-tip-text">
                                                提示：需先填写行程并点击「加入代购圈」，才能联系买家
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- 无数据提示（统一空状态风格） -->
                <div class="apple-empty-state">
                    <p>暂无商品信息</p>
                    <p class="text-secondary-apple">买家提交购物需求后将在此展示</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 引入Bootstrap图标 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}