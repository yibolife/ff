{% extends "base.html" %}

{% block title %}已联系行程 - 代购购物平台{% endblock %}

{% block content %}
<!-- 苹果风格核心样式 -->
<style>
    /* 引入苹果官方字体 */
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap');

    :root {
        /* 苹果原生色调体系 */
        --apple-bg: #f5f5f7;
        --apple-card-bg: #ffffff;
        --apple-border: #e6e6e8;
        --apple-text-primary: #1d1d1f;
        --apple-text-secondary: #86868b;
        --apple-accent: #0071e3; /* 苹果蓝（核心蓝色） */
        --apple-success: #34c759; /* 苹果绿 */
        --apple-warning: #ff9500; /* 苹果橙 */
        --apple-secondary: #86868b; /* 苹果灰 */
        --apple-light-bg: #f2f2f7;
        --apple-light-blue: rgba(0, 113, 227, 0.1); /* 新增：浅蓝背景色 */

        /* 状态色 - 全部改为苹果蓝系（统一买家卡片底色） */
        --status-confirmed: var(--apple-accent); /* 已确认：标准苹果蓝 */
        --status-pending: #0077ed; /* 待确认：苹果蓝hover色（略深） */
        --status-default: #5ac8fa; /* 默认：苹果浅蓝（仍属蓝色系） */

        /* 通用过渡动画 */
        --apple-transition: all 0.2s ease-in-out;
    }

    /* 全局样式重置 */
    body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--apple-bg);
        color: var(--apple-text-primary);
        line-height: 1.45;
    }

    /* 页面容器优化 */
    .apple-container {
        max-width: 1280px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    /* 标题栏样式 */
    .apple-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem; /* 新增：按钮之间的间距 */
    }

    .apple-page-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--apple-text-primary);
        margin: 0;
        letter-spacing: -0.02em;
    }

    /* 新增：统一的跳转按钮样式（和之前的购物信息按钮一致） */
    .apple-back-shopping-btn {
        background-color: var(--apple-light-blue) !important;
        color: var(--apple-accent) !important;
        border: none !important;
        border-radius: 16px !important;
        padding: 0.5rem 1rem !important;
        font-size: 0.9rem !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        margin-bottom: 1rem !important;
        transition: background-color 0.2s ease-in-out !important;
        cursor: pointer !important;
        text-decoration: none !important; /* 关键：取消默认下划线 */
    }

    .apple-back-shopping-btn:hover {
        background-color: rgba(0, 113, 227, 0.2) !important;
        text-decoration: none !important; /* 关键：hover时也无下划线 */
    }

    /* 苹果风格按钮 */
    .btn-apple {
        border-radius: 20px;
        font-weight: 500;
        padding: 8px 16px;
        border: none;
        transition: var(--apple-transition);
        font-size: 0.9rem;
    }

    .btn-apple-primary {
        background-color: var(--apple-accent);
        color: white;
    }

    .btn-apple-primary:hover {
        background-color: #0077ed;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }

    .btn-apple-outline {
        border-radius: 20px;
        font-weight: 500;
        padding: 8px 16px;
        border: 1px solid var(--apple-border);
        background-color: transparent;
        transition: var(--apple-transition);
        font-size: 0.9rem;
    }

    .btn-apple-outline-primary {
        color: var(--apple-accent);
        border-color: var(--apple-accent);
    }

    .btn-apple-outline-primary:hover {
        background-color: rgba(0, 113, 227, 0.05);
        color: var(--apple-accent);
    }

    .btn-apple-outline-danger {
        color: #ff3b30;
        border-color: #ff3b30;
    }

    .btn-apple-outline-danger:hover {
        background-color: rgba(255, 59, 48, 0.05);
        color: #ff3b30;
    }

    .btn-apple-outline-secondary {
        color: var(--apple-text-secondary);
        border-color: var(--apple-border);
    }

    .btn-apple-success {
        background-color: var(--apple-success);
        color: white;
    }

    .btn-apple-success:hover {
        background-color: #2db84e;
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }

    /* 行程卡片样式 */
    .apple-trip-card {
        background-color: var(--apple-card-bg);
        border-radius: 18px;
        border: 1px solid var(--apple-border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        height: 100%;
        transition: var(--apple-transition);
    }

    .apple-trip-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    /* 卡片头部（状态色）- 统一为苹果蓝系 */
    .card-header-apple {
        padding: 1rem 1.5rem;
        border-bottom: none;
        color: white;
    }

    .status-confirmed {
        background-color: var(--status-confirmed); /* 标准苹果蓝 */
    }

    .status-pending {
        background-color: var(--status-pending); /* 苹果蓝hover色 */
    }

    .status-default {
        background-color: var(--status-default); /* 苹果浅蓝 */
    }

    .card-header-apple h5 {
        font-weight: 500;
        margin: 0;
        font-size: 1.1rem;
    }

    /* 卡片内容区 */
    .card-body-apple {
        padding: 1.5rem;
    }

    /* 信息区块样式 */
    .info-block {
        background-color: rgba(0, 113, 227, 0.05);
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .product-block {
        background-color: var(--apple-light-bg);
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
    }

    /* 卡片底部操作区 - 优化间距+flex布局 */
    .card-footer-apple {
        padding: 1rem 1.5rem;
        background-color: transparent;
        border-top: 1px solid var(--apple-border);
        display: flex;
        justify-content: space-between;
        gap: 1rem; /* 增大按钮间距，更舒展 */
    }

    /* 空状态样式 */
    .apple-empty-state {
        background-color: var(--apple-card-bg);
        border-radius: 18px;
        border: 1px solid var(--apple-border);
        text-align: center;
        padding: 4rem 2rem;
        color: var(--apple-text-secondary);
        margin: 2rem 0;
    }

    /* 文字样式优化 */
    .text-primary-apple {
        color: var(--apple-text-primary);
    }

    .text-secondary-apple {
        color: var(--apple-text-secondary);
    }

    .text-danger-apple {
        color: #ff3b30;
    }

    /* 响应式适配 */
    @media (max-width: 768px) {
        .apple-page-title {
            font-size: 1.5rem;
        }

        .card-body-apple {
            padding: 1rem;
        }

        .card-footer-apple {
            padding: 1rem;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn-apple, .btn-apple-outline {
            width: 100%;
        }
    }

    @media (max-width: 992px) {
        .apple-header-bar {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
</style>

<div class="apple-container">
    <!-- 页面标题与操作栏 -->
    <div class="apple-header-bar">
        <!-- 前往购物圈按钮 -->
        <a href="{{ url_for('shopping.shopping_circle') }}" class="apple-back-shopping-btn">
            <i class="bi bi-plus-circle"></i> 购物圈
        </a>

        <!-- 修改：编辑行程按钮改为点击触发JS确认弹窗 -->
        <button id="editItineraryBtn" class="apple-back-shopping-btn">
            <i class="bi bi-pencil"></i> 编辑行程
        </button>
    </div>

    <!-- 行程列表 -->
    {% if trips %}
        <div class="row gap-4">
            {% for trip in trips %}
                <!-- 多层条件判断容错 -->
                {% set binding = trip.binding if trip.binding else {} %}
                {% set buyer = trip.buyer if (trip.buyer) else (binding.buyer if (binding and binding.buyer) else {}) %}
                {% set buyer_circle = trip.buyer_circle if trip.buyer_circle else {} %}
                {% set buyer_products = trip.buyer_products if trip.buyer_products else [] %}
                {% set agent_itinerary = trip.agent_itinerary if (trip.agent_itinerary) else (current_user.agent_itinerary if current_user.agent_itinerary else {}) %}

                <!-- 行程卡片 -->
                <div class="col-md-6 col-lg-4">
                    <div class="apple-trip-card">
                        <!-- 卡片头部（绑定状态）- 底色统一为苹果蓝系 -->
                        <div class="card-header-apple
                            {% if binding.status == 'confirmed' %}status-confirmed{% elif binding.status == 'pending' %}status-pending{% else %}status-default{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- 买家用户名 -->
                                <h5 class="mb-0">
                                    买家：
                                    {% if buyer and buyer.username %}
                                        {{ buyer.username }}
                                    {% elif binding and binding.buyer_username %}
                                        {{ binding.buyer_username }}
                                    {% else %}
                                        未知用户
                                    {% endif %}
                                </h5>
                            </div>
                        </div>

                        <!-- 卡片-body -->
                        <div class="card-body-apple">
                            <!-- 买家基础信息 -->
                            <div class="mb-3">
                                <p class="mb-1 text-secondary-apple"><strong>绑定时间：</strong>
                                    {% if binding and binding.created_at %}
                                        {{ binding.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        未知时间
                                    {% endif %}
                                </p>
                                <p class="mb-0 text-secondary-apple"><strong>买家电话：</strong>
                                    {% if buyer and buyer.phone %}
                                        {{ buyer.phone[:3] }}****{{ buyer.phone[-4:] }}
                                    {% elif binding and binding.buyer_phone %}
                                        {{ binding.buyer_phone[:3] }}****{{ binding.buyer_phone[-4:] }}
                                    {% else %}
                                        <span class="text-secondary-apple">未填写</span>
                                    {% endif %}
                                </p>
                            </div>

                            <!-- 代购行程信息 -->
                            <div class="info-block mb-3">
                                <h6 class="text-primary mb-2" style="color: var(--apple-accent) !important;">行程</h6>
                                <p class="mb-1 text-secondary-apple"><strong>目的地：</strong>
                                    {% if agent_itinerary and agent_itinerary.location %}
                                        {{ agent_itinerary.location }}
                                    {% else %}
                                        未设置
                                    {% endif %}
                                </p>
                                <p class="mb-1 text-secondary-apple"><strong>出行时间：</strong>
                                    {% if agent_itinerary and agent_itinerary.time %}
                                        {{ agent_itinerary.time.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        未设置
                                    {% endif %}
                                </p>
                                <p class="mb-0 text-secondary-apple"><strong>行程描述：</strong>
                                    {% if agent_itinerary and agent_itinerary.itinerary %}
                                        {{ agent_itinerary.itinerary }}
                                    {% elif agent_itinerary and agent_itinerary.description %}
                                        {{ agent_itinerary.description }}
                                    {% else %}
                                        未填写
                                    {% endif %}
                                </p>
                            </div>

                            <!-- 买家购物信息 -->
                            {% if buyer_circle %}
                                <div class="mb-3">
                                    <p class="mb-1 text-secondary-apple"><strong>提交时间：</strong>
                                        {% if buyer_circle.submit_time %}
                                            {{ buyer_circle.submit_time.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            未知
                                        {% endif %}
                                    </p>
                                    <p class="mb-0 text-secondary-apple"><strong>总金额：</strong>
                                        <span class="text-danger-apple fs-6">{{ "%.2f"|format(buyer_circle.total_price if buyer_circle.total_price else 0) }} 元</span>
                                    </p>
                                </div>

                                <!-- 商品清单 -->
                                <div class="product-block mb-2">
                                    <h6 class="mb-2 text-primary-apple">商品清单（{{ buyer_products|length }} 件）：</h6>
                                    {% if buyer_products %}
                                        <ul class="list-unstyled mb-0">
                                            {% for product in buyer_products %}
                                                <li class="d-flex justify-content-between py-1 border-bottom border-light">
                                                    <span class="text-secondary-apple">{{ loop.index }}. {{ product.product_name if (product and product.product_name) else '未知商品' }}</span>
                                                    <span class="text-secondary-apple">{{ product.price if (product and product.price) else 0 }} 元</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-secondary-apple mb-0">暂无商品信息</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-info p-2 mb-3 text-center" style="border-radius: 12px; border: 1px solid var(--apple-border); background-color: rgba(0, 113, 227, 0.05); color: var(--apple-accent);">
                                    买家暂无提交购物需求
                                </div>
                            {% endif %}
                        </div>

                        <!-- 卡片底部（操作按钮）- 调整flex占比 -->
                        <div class="card-footer-apple">
                            <!-- 实时聊天按钮：flex:1（次要操作） -->
                            {% if binding and binding.id and binding.status in ['confirmed', 'binded'] %}
                                <a href="{{ url_for('chat.chat_room', binding_id=binding.id) }}" class="btn btn-apple-outline btn-apple-outline-primary flex-1">
                                    实时聊天
                                </a>
                            {% endif %}

                            <!-- 解除绑定按钮：flex:2（主要操作，宽度更宽） -->
                            {% if binding and binding.id %}
                                <form action="{{ url_for('binding.unbind', binding_id=binding.id) }}" method="POST" style="display: flex; flex: 0.5;">
                                    {{ form.hidden_tag() }}
                                    {% if binding.status in ['confirmed', 'binded'] %}
                                        <button type="submit" class="btn btn-apple-outline btn-apple-outline-danger w-100" onclick="return confirm('确定要解除与 {{ buyer.username|default('未知用户', true) }} 的绑定吗？解除后不可恢复！')">
                                            解除绑定
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-apple-outline btn-apple-outline-secondary w-100" disabled>
                                            不可解除
                                        </button>
                                    {% endif %}
                                </form>
                            {% else %}
                                <button type="button" class="btn btn-apple-outline btn-apple-outline-secondary flex-1" disabled>
                                    无效绑定
                                </button>
                            {% endif %}

                            <!-- 确认绑定按钮：flex:1（补充操作） -->
                            {% if binding and binding.status == 'pending' and binding.id %}
                                <a href="{{ url_for('binding.confirm_binding', binding_id=binding.id) }}" class="btn btn-apple btn-apple-success flex-1">
                                    确认绑定
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- 无数据提示 -->
        <div class="apple-empty-state">
            <i class="bi bi-info-circle fs-4 mb-2"></i>
            <p class="mb-3">暂无绑定的商品</p>
        </div>
    {% endif %}
</div>

<!-- 新增：编辑行程弹窗确认JS -->
<script>
    // 编辑行程按钮点击事件
    document.getElementById('editItineraryBtn').addEventListener('click', function() {
        // 弹出确认提示框，与解除绑定逻辑一致
        var confirmEdit = confirm('更新行程后需要通知到绑定的买家');
        // 确认后跳转到编辑行程页面
        if (confirmEdit) {
            window.location.href = "{{ url_for('agent.agent_info') }}";
        }
    });
</script>
{% endblock %}