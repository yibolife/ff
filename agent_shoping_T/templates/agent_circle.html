{% extends "base.html" %}

{% block title %}代购圈 - 代购/购物系统{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="text-center">
                    {% if current_user.is_authenticated and current_user.is_agent %}
                        代购行程管理
                    {% else %}
                        代购用户行程信息
                    {% endif %}
                </h2>
            </div>
            <div class="card-body">
                {% if agent_data %}
                    <div class="row row-cols-1 row-cols-md-2 g-4">
                        {% for entry in agent_data %}
                            <div class="col">
                                <div class="card h-100 border-primary">
                                    <div class="card-body">
                                        <!-- 代购基本信息 -->
                                        <h5 class="card-title">代购人：{{ entry.user.username }}</h5>
                                        <p class="card-text">
                                            <strong>联系电话：</strong>
                                            {% if entry.user.phone and entry.user.phone|length == 11 %}
                                                {{ entry.user.phone[:3] }}****{{ entry.user.phone[-4:] }}
                                            {% else %}
                                                {{ entry.user.phone or '未设置' }}
                                            {% endif %}
                                            <br>
                                            <strong>代购时间：</strong>{{ entry.agent_info.time.strftime('%Y-%m-%d %H:%M') if entry.agent_info.time else '未设置' }}<br>
                                            <strong>代购地点：</strong>{{ entry.agent_info.location or '未设置' }}
                                        </p>

                                        <!-- 行程安排 -->
                                        <div class="mt-3">
                                            <h6>行程安排：</h6>
                                            <div class="bg-light p-3 rounded">
                                                {{ entry.agent_info.itinerary|replace('\n', '<br>')|safe if entry.agent_info.itinerary else '暂无行程描述' }}
                                            </div>
                                        </div>

                                        <!-- 操作按钮：仅保留代购的编辑按钮 -->
                                        <div class="mt-4">
                                            <!-- 移除“联系代购并绑定”按钮（非代购用户也不显示） -->

                                            <!-- 代购用户的编辑按钮保持不变 -->
                                            {% if current_user.is_authenticated and current_user.is_agent and current_user.id == entry.user.id %}
                                                <a href="{{ url_for('agent.agent_info') }}" class="btn btn-primary">
                                                    编辑我的行程
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- 无代购数据时的提示 -->
                    <div class="text-center p-5">
                        {% if current_user.is_authenticated and current_user.is_agent %}
                            <p class="text-muted fs-5">你尚未提交行程信息</p>
                            <p class="text-secondary">完善行程后将在此展示你的代购信息</p>
                            <a href="{{ url_for('agent.agent_info') }}" class="btn btn-primary mt-3">立即完善行程</a>
                        {% else %}
                            <p class="text-muted fs-5">暂无已提交的代购信息</p>
                            <p class="text-secondary">代购用户填写并提交行程后将在此展示</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- 优化后的消息提示区域：直接使用后端传递的 messages 变量 -->
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mt-4" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}