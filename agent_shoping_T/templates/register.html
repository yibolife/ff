{% extends "base.html" %}

{% block title %}注册 - 代购/购物系统{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-center">用户注册</h2>
                </div>
                <div class="card-body">
                    <form method="POST" id="registerForm">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            {{ form.username.label(class="form-label") }}
                            {{ form.username(
                                class="form-control" + (" is-invalid" if form.username.errors else ""),
                                placeholder="请输入用户名（3-20位字符）",
                                maxlength="20"
                            ) }}
                            {% if form.username.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.username.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.phone.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.phone(
                                    class="form-control" + (" is-invalid" if form.phone.errors else ""),
                                    placeholder="请输入11位中国大陆手机号",
                                    id="phoneInput",
                                    maxlength="11"
                                ) }}
                                {% if form.phone.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.phone.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <!-- 核心修复1：按钮id改为 getCodeBtn（与JS中一致） -->
                                <button type="button" class="btn btn-outline-secondary" id="getCodeBtn" onclick="sendVerifyCode()">
                                    获取验证码
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.verify_code.label(class="form-label") }}
                            {{ form.verify_code(
                                class="form-control" + (" is-invalid" if form.verify_code.errors else ""),
                                placeholder="获取验证码后，请直接输入：123456",
                                maxlength="6"
                            ) }}
                            {% if form.verify_code.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.verify_code.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div id="codeMsg" class="form-text mt-1"></div>
                        </div>

                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center">
                    已有账号？<a href="{{ url_for('auth.login') }}">登录</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let countdown = 0;
        let timer = null;

        // 核心修复2：确保函数内能正确获取按钮元素（添加容错处理）
        function sendVerifyCode() {
            // 优先通过id获取按钮（确保id与模板一致）
            const codeBtn = document.getElementById('getCodeBtn');
            const phoneInput = document.getElementById('phoneInput');
            const phone = phoneInput.value.trim();
            const codeMsg = document.getElementById('codeMsg');

            // 容错处理：若未找到按钮，直接提示错误
            if (!codeBtn) {
                codeMsg.className = 'form-text text-danger mt-1';
                codeMsg.textContent = '按钮元素未找到，请刷新页面重试';
                console.error('错误：未找到id为 getCodeBtn 的按钮');
                return;
            }

            // 前端手机号验证
            if (!phone) {
                codeMsg.className = 'form-text text-danger mt-1';
                codeMsg.textContent = '请先输入手机号';
                phoneInput.focus();
                return;
            }
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                codeMsg.className = 'form-text text-danger mt-1';
                codeMsg.textContent = '请输入有效的11位中国大陆手机号';
                phoneInput.focus();
                return;
            }

            // 按钮状态切换（直接操作已获取的codeBtn，避免重复查询DOM）
            codeBtn.disabled = true;
            codeBtn.textContent = '发送中...';
            codeMsg.className = 'form-text text-muted mt-1';
            codeMsg.textContent = '';

            // 获取CSRF令牌（从form.hidden_tag()生成的隐藏字段）
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            if (!csrfToken) {
                codeMsg.className = 'form-text text-danger mt-1';
                codeMsg.textContent = 'CSRF令牌未找到，请刷新页面';
                resetCodeBtn(codeBtn); // 传入按钮元素
                return;
            }

            // 后端接口地址（确保与auth.py中的路由一致）
            const apiUrl = '{{ url_for('auth.send_verify_code_api') }}';
            console.log('请求接口地址：', apiUrl);
            console.log('携带参数：', { phone: phone });

            // 发送请求
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ phone: phone })
            })
            .then(response => {
                console.log('响应状态码：', response.status);
                if (!response.ok) {
                    // 非200状态码：解析错误信息
                    return response.json().catch(() => response.text()).then(errMsg => {
                        throw new Error(`状态码${response.status}：${errMsg}`);
                    });
                }
                // 解析响应（兼容JSON和文本）
                return response.json().catch(() => response.text());
            })
            .then(data => {
                console.log('后端返回数据：', data);
                // 处理后端响应
                if (typeof data === 'object' && data.success !== undefined) {
                    if (data.success) {
                        codeMsg.className = 'form-text text-success mt-1';
                        codeMsg.textContent = data.message;
                        startCountdown(codeBtn); // 传入按钮元素
                    } else {
                        codeMsg.className = 'form-text text-danger mt-1';
                        codeMsg.textContent = data.message || '验证码发送失败';
                        resetCodeBtn(codeBtn); // 传入按钮元素
                    }
                } else {
                    codeMsg.className = 'form-text text-danger mt-1';
                    codeMsg.textContent = `后端响应异常：${String(data).slice(0, 50)}`;
                    resetCodeBtn(codeBtn); // 传入按钮元素
                }
            })
            .catch(error => {
                console.error('验证码发送失败详情：', error);
                // 精准提示错误类型
                if (error.message.includes('404')) {
                    codeMsg.textContent = '接口地址错误（后端路由未找到）';
                } else if (error.message.includes('403')) {
                    codeMsg.textContent = 'CSRF验证失败，请刷新页面';
                } else if (error.message.includes('Failed to fetch')) {
                    codeMsg.textContent = '网络不通，请检查服务器状态或网络连接';
                } else {
                    codeMsg.textContent = `发送失败：${error.message.slice(0, 50)}`;
                }
                resetCodeBtn(codeBtn); // 传入按钮元素
            });
        }

        // 核心修复3：倒计时函数（接收按钮元素作为参数，避免重复查询DOM）
        function startCountdown(codeBtn) {
            countdown = 60;
            codeBtn.textContent = `${countdown}秒后重新获取`;

            timer = setInterval(() => {
                countdown--;
                codeBtn.textContent = `${countdown}秒后重新获取`;

                if (countdown <= 0) {
                    clearInterval(timer);
                    resetCodeBtn(codeBtn); // 传入按钮元素
                }
            }, 1000);
        }

        // 核心修复4：恢复按钮状态函数（接收按钮元素作为参数，避免查询DOM失败）
        function resetCodeBtn(codeBtn) {
            // 容错处理：确保codeBtn是有效元素
            if (codeBtn && typeof codeBtn.disabled !== 'undefined') {
                codeBtn.disabled = false;
                codeBtn.textContent = '获取验证码';
            } else {
                console.error('错误：重置按钮时未传入有效元素');
            }
        }

        // 核心修复5：替换unload事件（避免浏览器权限警告）
        window.addEventListener('beforeunload', function() {
            if (timer) clearInterval(timer);
        });

        // 监听手机号输入，清除错误提示
        document.getElementById('phoneInput')?.addEventListener('input', function() {
            const codeMsg = document.getElementById('codeMsg');
            if (codeMsg && codeMsg.classList.contains('text-danger')) {
                codeMsg.className = 'form-text mt-1';
                codeMsg.textContent = '';
            }
        });
    </script>
{% endblock %}