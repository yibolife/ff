{% extends "base.html" %}

{% block title %}购物信息 - 代购/购物系统{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <!-- 左侧添加商品区域 -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h2 class="text-center mb-0 fs-5">添加商品信息</h2>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" action="{{ url_for('shopping.shopping_info') }}">
                            {{ form.hidden_tag() }}

                            <!-- 商品序号 -->
                            <div class="mb-3">
                                {{ form.serial_number.label(class="form-label") }}
                                {{ form.serial_number(class="form-control" + (" is-invalid" if form.serial_number.errors else ""), placeholder="输入商品序号（最多20字符）") }}
                                {% if form.serial_number.errors %}
                                    <div class="invalid-feedback">{{ form.serial_number.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 商品名称 -->
                            <div class="mb-3">
                                {{ form.product_name.label(class="form-label") }}
                                {{ form.product_name(class="form-control" + (" is-invalid" if form.product_name.errors else ""), placeholder="输入商品名称（最多100字符）") }}
                                {% if form.product_name.errors %}
                                    <div class="invalid-feedback">{{ form.product_name.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 商品价格 -->
                            <div class="mb-3">
                                {{ form.price.label(class="form-label") }}
                                {{ form.price(class="form-control" + (" is-invalid" if form.price.errors else ""), placeholder="输入价格（整数或最多两位小数）") }}
                                {% if form.price.errors %}
                                    <div class="invalid-feedback">{{ form.price.errors[0] }}</div>
                                {% endif %}
                                <div class="form-text">示例：100 或 99.99</div>
                            </div>

                            <!-- 商品图片 -->
                            <div class="mb-3">
                                {{ form.product_image.label(class="form-label") }}
                                {{ form.product_image(class="form-control", id="productImageInput") }}
                                <!-- 图片预览区域 -->
                                <div class="mt-2" id="imagePreview" style="display: none;">
                                    <h5 class="fs-6">预览图：</h5>
                                    <img id="previewImg" src="" alt="商品图片预览" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                                </div>
                                <div class="form-text">支持JPG、PNG格式，最大5MB</div>
                            </div>

                            <!-- 商品描述 -->
                            <div class="mb-3">
                                {{ form.description.label(class="form-label") }}
                                {{ form.description(class="form-control", rows=3, placeholder="可选：输入商品规格、备注等信息") }}
                            </div>

                            <!-- 提交按钮 -->
                            <div class="d-grid">
                                {{ form.submit(class="btn btn-info") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 右侧已添加商品区域 -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h2 class="text-center mb-0 fs-5">已添加的商品</h2>
                    </div>
                    <div class="card-body">
                        {% if shopping_items %}
                            <!-- 商品表格 -->
                            <div class="table-responsive mb-4">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>序号</th>
                                            <th>商品名称</th>
                                            <th>价格（元）</th>
                                            <th>图片</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in shopping_items %}
                                            <tr>
                                                <td>{{ item.serial_number }}</td>
                                                <td>{{ item.product_name }}</td>
                                                <td>{{ "%.2f"|format(item.price) }}</td>
                                                <td>
                                                    {% if item.product_image %}
                                                        <!-- 大图预览模态框触发按钮 -->
                                                        <button type="button" class="btn p-0" data-bs-toggle="modal" data-bs-target="#imageModal{{ item.id }}" title="查看大图">
                                                            <img src="{{ url_for('static', filename='uploads/' + item.product_image) }}"
                                                                 alt="{{ item.product_name }}"
                                                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #eee;">
                                                        </button>

                                                        <!-- 大图预览模态框 -->
                                                        <div class="modal fade" id="imageModal{{ item.id }}" tabindex="-1" aria-hidden="true">
                                                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title">{{ item.product_name }}</h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body p-0">
                                                                        <img src="{{ url_for('static', filename='uploads/' + item.product_image) }}"
                                                                             alt="{{ item.product_name }}"
                                                                             style="width: 100%; height: auto; object-fit: contain;">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <span class="text-muted">无图片</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <!-- 删除商品表单（核心修复：使用 delete_form.hidden_tag() 自动生成 CSRF Token） -->
                                                    <form method="POST" action="{{ url_for('shopping.shopping_info') }}" style="margin: 0;">
                                                        <!-- 自动生成 CSRF Token（无需手动写） -->
                                                        {{ delete_form.hidden_tag() }}
                                                        <!-- 手动传递商品ID -->
                                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                                        <!-- 删除按钮 -->
                                                        <button type="submit" name="delete_item" class="btn btn-danger btn-sm"
                                                                onclick="return confirm('确定要删除【{{ item.product_name }}】吗？删除后不可恢复！');">
                                                            删除
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- 总价和提交区域 -->
                            <div class="mt-4 p-4 bg-light rounded shadow-sm">
                                <h4 class="text-center mb-3">
                                    商品总价：<span class="text-danger fw-bold">{{ "%.2f"|format(total_price) }}</span> 元
                                </h4>
                                <form method="POST" action="{{ url_for('shopping.shopping_info') }}">
                                    {{ submit_form.hidden_tag() }}
                                    <div class="d-grid">
                                        {{ submit_form.submit(class="btn btn-success btn-lg") }}
                                    </div>
                                    <small class="text-center d-block mt-2 text-muted">
                                        点击后跳转到代购圈，查看代购用户的行程信息
                                    </small>
                                </form>
                            </div>
                        {% else %}
                            <!-- 空状态提示 -->
                            <div class="text-center py-5">
                                <div class="alert alert-light border" role="alert">
                                    <i class="bi bi-cart-plus fs-3 text-info"></i>
                                    <p class="mt-2 fs-5">还没有添加任何商品</p>
                                    <p class="text-muted">请在左侧填写商品信息并添加</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览JS -->
    <script>
        const imageInput = document.getElementById('productImageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 校验文件类型
                const fileType = file.type.split('/')[0];
                if (fileType !== 'image') {
                    alert('请选择图片文件（支持JPG、PNG格式）');
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    return;
                }

                // 校验文件大小（5MB）
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    alert('图片文件过大，请选择5MB以内的图片');
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    return;
                }

                // 预览图片
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImg.src = event.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });

        // Flash消息自动隐藏
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.add('fade-out');
                    setTimeout(() => alert.remove(), 500);
                }, 3000);
            });
        });
    </script>

    <!-- 引入Bootstrap图标和样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
{% endblock %}